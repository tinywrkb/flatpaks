name: wine
buildsystem: simple
build-commands:
  - install -dm755 ${FLATPAK_DEST}/lib/i386-linux-gnu
  - install -dm755 ${FLATPAK_DEST}/lib/debug/lib/i386-linux-gnu
  - install -dm755 ${FLATPAK_DEST}/lib/i386-linux-gnu/GL
  - install -dm755 ${FLATPAK_DEST}/lib/i386-linux-gnu/dri/intel-vaapi-driver
  # ffmpeg can be used with wine-staging
  #- install -dm755 ${FLATPAK_DEST}/lib/x86_64-linux-gnu/ffmpeg
  #- install -dm755 ${FLATPAK_DEST}/lib/i386-linux-gnu/ffmpeg
  - |
    install -Dm644 /dev/stdin ${FLATPAK_DEST}/etc/ld.so.conf <<EOF
    /app/lib32
    ${FLATPAK_DEST}/lib/i386-linux-gnu
    EOF
  - cp -R --preserve=timestamps ${FLATPAK_DEST}/src/wine64 .
  - make -C wine64 install
modules:
  - ../shared-modules/opencl-headers/opencl-headers.json
  - name: wine64
    no-make-install: true
    config-opts:
      - --enable-win64
      - --libdir=/app/lib
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/src
      - cp -r $FLATPAK_BUILDER_BUILDDIR ${FLATPAK_DEST}/src/wine64
    sources: &wine_sources
      #- type: archive
      #  url: https://dl.winehq.org/wine/source/6.x/wine-6.3.tar.xz
      #  sha256: 682a77c1fd12f56347ca2080d85fe17def1b655d3241d94582f87591d9d0cc3b
      #  x-checker-data:
      #    type: anitya
      #    project-id: 5134
      #    stable-only: true
      #    url-template: https://dl.winehq.org/wine/source/$version0.x/wine-$version.tar.xz
      - type: git
        url: https://gitlab.collabora.com/alf/wine.git
        branch: wayland
        commit: 379089df79ab4405b442f8fbfc424e4d24a0b10c
      - type: file
        path: wine-configure-wrapper
        dest-filename: configure-wrapper
      - type: shell
        commands:
          # workaround for failure of configure script to detect lib32-libpcap
          - sed -i '/^if test .*ac_cv_lib_pcap_pcap_create.*!= xyes/, /^fi$/d' configure
          # common configure options
          - |
            mv configure{,.wine}
            ln -s configure{-wrapper,}
    cleanup:
      - /share/applications
      - /share/man/*.UTF-8
      - /src
    modules:
      - ../shared-modules/glu/glu.json
      - ../shared-modules/gsm/gsm.json
      - ../shared-modules/libpcap/libpcap.json
      - ../shared-modules/libxmu/libxmu.json
      - ../shared-modules/samba/samba.json
      - ../shared-modules/sane/libsane.json
      - faudio/faudio.json
      - vkd3d/vkd3d.json
  - name: wine32
    build-options:
      arch:
        x86_64:
          prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
          ldflags: -L/app/lib32
          prepend-path: /usr/lib/sdk/toolchain-i386/bin
          env:
            CC: i686-unknown-linux-gnu-gcc
            CXX: i686-unknown-linux-gnu-g++
          libdir: /app/lib32
    config-opts:
      - --with-win64=/app/src/wine64
      # workaround for failure of configure script to detect libpcap
      - PCAP_LIBS=/app/lib32/libpcap.so
    sources: *wine_sources
    cleanup:
      - /share/applications
      - /share/man/*.UTF-8
    modules:
      - ../shared-modules/glu/lib32-glu.json
      - ../shared-modules/gsm/lib32-gsm.json
      - ../shared-modules/libpcap/lib32-libpcap.json
      - ../shared-modules/libxmu/lib32-libxmu.json
      - ../shared-modules/samba/lib32-samba.json
      - ../shared-modules/sane/lib32-libsane.json
      - faudio/lib32-faudio.json
      - vkd3d/lib32-vkd3d.json
